# Configuration for Travis CI
language: rust
sudo: required
services:
  - docker
addons:
  apt:
    packages:
      - libssl-dev

      # Cross compiler dependencies for ARM
      # - gcc-arm-linux-gnueabihf
      # - libc6-armhf-cross
      # - libc6-dev-armhf-cross

stages:
  - build
  - test
  - name: release
    if: tag =~ ^v(\d+\.)*\d+$

jobs:
  include:
    - stage: build
      rust: stable
      env: TARGET=x86_64-unknown-linux-gnu
      script: &build-script
        - cargo build --verbose --all
        - cargo build --no-default-features --verbose --all
        - cargo build --features no-color --verbose --all
      cache: cargo
    - stage: build
      rust: stable
      env: TARGET=i686-unknown-linux-gnu
      script: &build-script-cross
        - cargo install cross
        - cross build --target $TARGET --verbose --all
        - cross build --target $TARGET --no-default-features --verbose --all
        - cross build --target $TARGET --features no-color --verbose --all
    - stage: build
      rust: stable
      env: TARGET=aarch64-unknown-linux-gnu
      script: *build-script-cross
    - stage: build
      rust: stable
      env: TARGET=arm-unknown-linux-gnuabihf
      script: *build-script-cross
    - stage: build
      rust: stable
      env: TARGET=armv7-unknown-linux-gnuabihf
      script: *build-script-cross
    # - stage: build
    #   rust: stable
    #   env: TARGET=i686-unknown-freebsd
    #   script: *build-script-cross
    # - stage: build
    #   rust: stable
    #   env: TARGET=x86_64-unknown-freebsd
    #   script: *build-script-cross
    # - stage: build
    #   rust: stable
    #   env: TARGET=x86_64-unknown-netbsd
    #   script: *build-script-cross
    - stage: build
      rust: beta
      env: TARGET=x86_64-unknown-linux-gnu
      script: *build-script-cross
    - stage: build
      rust: nightly
      env: TARGET=x86_64-unknown-linux-gnu
      script: *build-script-cross
    - stage: build
      rust: stable
      os: osx
      env: TARGET=x86_64-unknown-linux-gnu
      script:
        - cargo build --verbose --all
        - cargo build --no-default-features --verbose --all
        - cargo build --features no-color --verbose --all
    - stage: test
      script: cargo test --verbose --all
      cache: cargo
    - stage: release
      env: TARGET=x86_64-unknown-linux-gnu
      script:
        - cargo install cross
        - cross build --target $TARGET --release --verbose --all
        - cd target/release
        - tar -czvf $TRAVIS_BUILD_DIR/ffsend-linux-x86_64.tar.gz ffsend
        - cd $TRAVIS_BUILD_DIR
      deploy:
        provider: releases
        api_key: $GITHUB_OAUTH_TOKEN
        skip_cleanup: true
        overwrite: false
        file: ffsend-x86_64-linux.tar.gz
        on:
          tags: true
          branch: master
      cache: cargo
    - stage: release
      script:
        - echo $CARGO_TOKEN | cargo login
        - cargo publish --verbose
      cache: cargo

# TODO: add BSD architecture
# TODO: use regular cargo commands for x86_64 linux
# TODO: release a build for each architecture
# TODO: enfore the git tag/crate version equality for releases
# TODO: disable addons/rust installation for GitHub release job
